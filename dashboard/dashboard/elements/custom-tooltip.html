<!DOCTYPE html>
<!--
Copyright 2016 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<!--
The 'custom-tooltip' displays overlaid pop-up above a target.

By default 'custom-tooltip' will close whenever other elements are focused
as well as automatically disappear after 'duration'.

Example usage:
  var target = event.target;
  var bound = target.getBoundingClientRect();
  var tooltip = document.getElementById("tooltip");
  tooltip.set('A tooltip message', bound.left, bound.top);
-->
<link rel="import" href="/components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/components/iron-overlay-behavior/iron-o
     verlay-behavior.html">
<link rel="import" href="/components/paper-material/paper-material.html">

<dom-module id="custom-tooltip">
  <style>
    :host {
      border: 1px solid black;
      position: absolute;
      background-color: rgba(31, 31, 31, 0.901961);
      color: white;
    }

    #container {
      overflow: hidden;
    }

    .message-content {
      margin: 3px;
    }
  </style>

  <template>
    <paper-material elevation="3">
      <iron-overlay-behavior id="overlay" target="" opened="{{opened}}"
          autoCloseDisabled="{{autoCloseDisabled}}"
          sizingTarget="{{$.container}}"
          transition="{{transition}}"></iron-overlay-behavior>

      <div id="container" horizontal layout  max-width="{{maxWidth}}">
        <div class="message-content" flex id="content"></div>
        <div class="message-content">
          <content></content>
        </div>
      </div>
    </paper-material>

  </template>

  <script>
    'use strict';
    Polymer({
      is: 'custom-tooltip',
      properties: {
        /**
         * Whether to close overlay if focus is taken somewhere else.
         */
        autoCloseDisabled: {
          type: Boolean,
          value: false,
          notify: true
        },
        /**
         * Number of milliseconds to stay opened. 0 to stay open indefinitely.
         */
        duration: {
          type: Number,
          value: 6000,
          notify: true
        },
        /**
         * Add event handler.
         * See: https://goo.gl/QIYbsB
         */
        eventDelegates: {
          type: Object,
          value: () => { 'core-resize': 'positionChanged' },
        },
        maxWidth: {
          notify: true
        },
        opened: {
          observer: 'openedChanged'
        },
        position: {
          observer: 'positionChanged'
        },
        transition: {
          notify: true
        }
      },

      ready: function() {
        this.$.overlay.addEventListener(
            'core-overlay-close-completed',
            this.onCoreOverlayClosed.bind(this), false);
      },

      /**
       * Sets and opens tooltip. If tooltip is already opened, it will close
       * then re-open.
       *
       * @param {string|HTMLElement} content Either string or HTMLElement.
       * @param {number} targetXpos target x position
       * @param {number} targetYpos target y position
       */
      set: function(content, targetXpos, targetYpos) {
        if (typeof content === 'string') {
          this.$.content.innerHTML = content;
        } else {
          this.$.content.innerHTML = '';
          Polymer.dom(this.$.content).appendChild(content);
        }
        this.targetXpos = targetXpos;
        this.targetYpos = targetYpos;
        this.style.opacity = 0;

        if (this.opened) {
          this.shouldOpen = true;
        } else {
          this.show();
        }
      },

      positionChanged: function(newVal, oldVal) {
        // Add a little delay to prevent window jumping when user clicks the
        // target too fast.
        this.debounce('positionJob', this.updatePosition, 50);
      },

      updatePosition: function() {
        var left = this.targetXpos - this.clientWidth / 2;
        var top = this.targetYpos - this.clientHeight - 15;
        this.style.top = top + 'px';
        this.style.left = left + 'px';
        this.style.opacity = 1;
      },

      /**
       * On "opened" changed, add a timer to hide overlay.
       */
      openedChanged: function() {
        if (this.opened && this.duration > 0) {
          if (this.hideJob) {
            this.hideJob.stop();
          }
          // https://www.polymer-project.org/0.5/docs/polymer/polymer.html#job
          this.hideJob = this.debounce(this.hideJob, this.hide, this.duration);
        }
      },

      /**
       * Handler for core overlay closed event.
       */
      onCoreOverlayClosed: function(event) {
        if (this.shouldOpen) {
          this.shouldOpen = false;
          this.show();
        }
      },

      /**
       * Hide this custom-tooltip.
       */
      hide: function() {
        this.opened = false;
      },

      /**
       * Show this custom-tooltip.
       */
      show: function() {
        this.opened = true;
      }
    });
  </script>
</dom-module>
