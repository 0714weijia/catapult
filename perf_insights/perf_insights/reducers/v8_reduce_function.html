<!DOCTYPE html>
<!--
Copyright 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/perf_insights/mre/function_handle.html">
<link rel="import" href="/tracing/base/units/histogram.html">

<script>
'use strict';

tr.exportTo('pi.r', function() {
  function ScriptCostInfo() {
    this.threadGroup = undefined;
    this.railTypeName = undefined;
    this.title = undefined;
    this.scriptURL = undefined;
    this.scriptURLClean = undefined;
    this.framework = undefined;
    this.userFriendlyCategory = undefined;

    this.selfTime = 0;
    this.cpuSelfTime = 0;

    this.traceURLs = {};
    this.sliceCount = 1;

    this.selfTimeHistogram = tr.b.u.Histogram.createLinear(
         tr.b.u.Units.timeDurationInMs,
         tr.b.Range.fromExplicitRange(0, 100),
         100);

    this.cpuSelfTimeHistogram = tr.b.u.Histogram.createLinear(
         tr.b.u.Units.timeDurationInMs,
         tr.b.Range.fromExplicitRange(0, 100),
         100);
  }

  ScriptCostInfo.asReduceTarget = function(firstValue) {
    var sliceCostInfo = new ScriptCostInfo();
    sliceCostInfo.threadGroup = firstValue.threadGroup;
    sliceCostInfo.railTypeName = firstValue.railTypeName;
    sliceCostInfo.title = firstValue.title;
    sliceCostInfo.scriptURL = firstValue.scriptURL;
    sliceCostInfo.scriptURLClean = firstValue.scriptURLClean;
    sliceCostInfo.framework = firstValue.framework;
    sliceCostInfo.userFriendlyCategory = firstValue.userFriendlyCategory;
    sliceCostInfo.traceURLs = [firstValue.traceURL];
    return sliceCostInfo;
  }

  ScriptCostInfo.prototype = {
    push: function(threadSlice) {
      if (threadSlice.selfTime !== undefined)
        this.selfTime += threadSlice.selfTime;
      if (threadSlice.cpuSelfTime !== undefined)
        this.cpuSelfTime += threadSlice.cpuSelfTime;

      if (threadSlice.traceURL !== undefined &&
          !threadSlice.traceURL in this.traceURLs) {
        this.traceURLs[threadSlice.traceURL] = true;
      }

      var sourceInfo = {
        sourceURL: threadSlice.traceURL
      }

      this.selfTimeHistogram.add(threadSlice.selfTime, sourceInfo);
      this.cpuSelfTimeHistogram.add(threadSlice.cpuSelfTime, sourceInfo);
      this.sliceCount += 1;
    }
  };

  function v8ReportReduceFunction(key, mapResults) {
    var reduceResults = {};
    tr.b.iterItems(mapResults[key], function(jobKey, jobResult) {
      tr.b.iterItems(jobResult, function(undefined, mapResult) {
        var reducingTarget = reduceResults[mapResult.key];
        if (!reducingTarget) {
          reducingTarget = ScriptCostInfo.asReduceTarget(mapResult.value);
          reduceResults[mapResult.key] = reducingTarget;
        }
        reducingTarget.push(mapResult.value);
      });
    });

    //console.log(JSON.stringify(reduceResults, undefined, 2));
    return reduceResults;
  }

  pi.mre.FunctionRegistry.register(v8ReportReduceFunction);

  return {
    v8ReportReduceFunction: v8ReportReduceFunction
  };
});
