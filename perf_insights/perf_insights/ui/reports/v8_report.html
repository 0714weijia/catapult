<!DOCTYPE html>
<!--
Copyright (c) 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<link rel="import" href="/tracing/ui/base/dom_helpers.html">
<link rel="import" href="/tracing/ui/base/overlay.html">
<link rel="import" href="/tracing/ui/base/table.html">
<link rel="import" href="/tracing/ui/units/time_duration_span.html">
<link rel="import" href="/perf_insights/mre/map_results.html">
<link rel="import" href="/perf_insights/ui/reports/pi_report.html">
<link rel="import" href="/perf_insights/ui/generic_results_view.html">
<link rel="import" href="/perf_insights/mappers/reduce.html">
<link rel="import" href="/perf_insights/mappers/slice_cost.html">

<polymer-element name="pi-ui-v8-report"
    extends="pi-ui-r-pi-report"
    map-function-href="/perf_insights/mappers/v8_map_function.html"
    map-function-name="v8ReportMapFunction"
    reduce-function-href="/perf_insights/reducers/v8_reduce_function.html"
    reduce-function-name="v8ReportReduceFunction">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
      }
      #table {
        flex: 1 1 auto;
      }
    </style>
<!--     <pre id="table2">
    </pre> -->
    <content-pane>
      <table-container>
        <pi-ui-grouping-table id="table"></pi-ui-grouping-table>
      </table-container>
    </content>
  </template>
  <script>
  'use strict';

  Polymer({
    created: function() {
      this.mapResults_ = undefined;
    },

    get mapResults() {
      return this.mapResults_;
    },

    set mapResults(mapResults) {
      this.mapResults_ = mapResults;
      this.updateContents_();
    },

    updateContents_: function() {
      var table = this.$.table;

      var results = this.mapResults_;
      if (!results)
        results = new pi.mre.MapResults();

      var allSliceCosts = [];
      tr.b.iterItems(results.reduceResults, function(name, result) {
        result = result[0];
        if (name != 'wr')
          return;

        console.log(result);
        result.sliceCosts.forEach(function(item) {
          var sliceCostInfo = pi.m.SliceCostInfo.fromDict(item);
          allSliceCosts.push({
            runInfo: result.runInfo,
            sliceCostInfo: sliceCostInfo
          });
        });
      });

      var groupBy = [];
      groupBy.push(function(datum) {
        return datum.sliceCostInfo.userFriendlyCategory || 'other';
      });
      groupBy.push(function(datum) {
        return datum.sliceCostInfo.title;
      });

      var columns = this.createColumns_();
      table.tableColumns = columns;
      table.sortColumnIndex = 2;
      table.sortDescending = true;
      table.selectionMode = tr.ui.b.TableFormat.SelectionMode.ROW;
      table.groupBy = groupBy;
      table.dataToGroup = allSliceCosts;
      table.rebuild();
      //this.$.table2.innerHTML = JSON.stringify(results.asDict(), undefined, 2);
    },

    createColumns_: function() {
      var columns = [
        {
          title: 'Title',
          value: function(row) {
            return row.title;
          },
          cmp: function(a, b) {
            return a.title.localeCompare(b.title);
          },
          width: '500px'
        },
        this.createCachingColumn_('Self time (total)', function(datum) {
          return datum.sliceCostInfo.selfTime;
        }),
        this.createCachingColumn_('CPU Self time (total)', function(datum) {
          return datum.sliceCostInfo.cpuSelfTime;
        })
      ];
      return columns;
    },

    createCachingColumn_(title, getDataFunction) {
      function computeStats(sliceCostInfo) {
        var sum = tr.b.Statistics.sum(sliceCostInfo, getDataFunction);
        return sum === undefined ? undefined :
            tr.ui.units.createTimeDurationSpan(sum);
      }

      var column = new pi.ui.CachingColumn(title, computeStats);
      column.textAlign = 'right';
      column.cmp = function(row0, row1) {
        var value0 = column.value(row0);
        var value1 = column.value(row1);
        return tr.b.comparePossiblyUndefinedValues(value0, value1,
            function(v0, v1) {
              return v0.duration - v1.duration;
            });
      };
      return column;
    }
  });
  </script>
</polymer-element>
