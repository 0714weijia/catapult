<!DOCTYPE html>
<!--
Copyright (c) 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<link rel="import" href="/perf_insights/mre/function_handle.html">
<link rel="import" href="/perf_insights/mre/map_single_trace.html">
<link rel="import" href="/perf_insights/mre/map_results.html">
<link rel="import" href="/perf_insights/mre/trace_handle.html">

<script>
'use strict';

tr.exportTo('pi.mre', function() {

  function mapSingleTraceMain(args) {
    if (args.length !== 3)
      throw new Error('Must provide three arguments');

    var options = {
      traceHandle: pi.mre.TraceHandle.fromDict(JSON.parse(args[0])),
      mapFunctionHandle: pi.mre.FunctionHandle.fromDict(JSON.parse(args[1])),
      filenameToMap: args[2]
    };

    var results = new pi.mre.MapResults();

    pi.mre.runAndConvertErrorsToFailures(
        results, options.runInfo,
        function() {
          var mapFunction = options.mapFunctionHandle.load();

          // Read the mapfile.
          try {
            var traceData = tr.b.getSync('file://' + options.filenameToMap);
          } catch (ex) {
            var err = new Error('Could not open ' + options.filenameToMap);
            err.name = 'TraceImportError';
            throw err;
          }

          pi.mre.mapSingleTrace(results, options.runInfo, traceData,
                            mapFunction, options.metadata);
        });

    results.results.forEach(function(result) {
      console.log('MAP_RESULT_VALUE: ' + JSON.stringify(result));
    });
    return 0;
  }

  return {
    mapSingleTraceMain: mapSingleTraceMain
  };
});

if (tr.isHeadless)
  quit(pi.mre.mapSingleTraceMain(sys.argv.slice(1)));

</script>

