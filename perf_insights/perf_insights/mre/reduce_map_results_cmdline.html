<!DOCTYPE html>
<!--
Copyright 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/base/xhr.html">

<link rel="import" href="/perf_insights/mre/job.html">
<link rel="import" href="/perf_insights/mre/job_results.html">
<link rel="import" href="/perf_insights/mre/map_results.html">
<link rel="import" href="/perf_insights/mre/reduce_map_results.html">
<link rel="import"
      href="/perf_insights/mre/run_and_convert_errors_to_failures.html">

<script>
'use strict';

tr.exportTo('pi.mre', function() {

  function reduceMapResultsMain(args) {
    if (args.length !== 2)
      throw new Error('Must provide two arguments');

    var options = {
      mapResultsFile: args[0],
      job: pi.mre.Job.fromDict(JSON.parse(args[1]))
    };

    var mapResultsLoaded = tr.b.getSync('file://' + options.mapResultsFile);
    var mapResults = JSON.parse(mapResultsLoaded);

    var jobResults = new pi.mre.JobResults();

    pi.mre.runAndConvertErrorsToFailures(
        jobResults, options.job, options.job.reduceFunctionHandle,
        undefined,
        function() {
          var reduceFunction = options.job.reduceFunctionHandle.load();
          pi.mre.reduceMapResults(jobResults, mapResults, reduceFunction);
        });

    console.log(JSON.stringify(jobResults.asDict()));
    return 0;
  }

  return {
    reduceMapResultsMain: reduceMapResultsMain
  };
});


if (tr.isHeadless)
  quit(pi.mre.reduceMapResultsMain(sys.argv.slice(1)));

</script>
